apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "app.fullname" . }}-server
  labels:
    app.kubernetes.io/name: {{ include "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: server
    helm.sh/chart: {{ include "app.chart" . }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  replicas: {{ .Values.immich.apiserver.replicas }}
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "app.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: server
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "app.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: server
    spec:
      {{- with .Values.immich.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: immich-server
          image: "{{ .Values.immich.apiserver.image.repository }}:{{ .Values.immich.apiserver.image.tag }}"
          imagePullPolicy: {{ .Values.immich.apiserver.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.immich.apiserver.service.port }}
          env:
            - name: TZ
              value: {{ .Values.immich.timezone | quote }}
            - name: DB_HOSTNAME
              value: {{ include "app.fullname" . }}-database
            - name: DB_PORT
              value: {{ .Values.immich.database.service.port | quote }}
            - name: DB_USERNAME
              value: {{ .Values.immich.apiserver.env.DB_USERNAME | quote }}
            - name: DB_DATABASE_NAME
              value: {{ .Values.immich.apiserver.env.DB_DATABASE_NAME | quote }}
            - name: DB_PASSWORD
              value: {{ .Values.immich.apiserver.env.DB_PASSWORD | quote }}
            - name: REDIS_HOSTNAME
              value: {{ include "app.fullname" . }}-redis
            - name: REDIS_PORT
              value: {{ .Values.immich.redis.service.port | quote }}
            - name: IMMICH_MACHINE_LEARNING_URL
              value: http://{{ include "app.fullname" . }}-ml:{{ .Values.immich.machineLearning.service.port }}
            - name: IMMICH_WORKERS_INCLUDE
              value: 'api'
          volumeMounts:
            {{- range .Values.immich.externalvolumes }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if hasKey . "readOnly" }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
      volumes:
        {{- range .Values.immich.externalvolumes }}
        - name: {{ .name }}
          nfs:
            server: {{ .server }}
            path: {{ .path }}
        {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "app.fullname" . }}-microservices
  labels:
    app.kubernetes.io/name: {{ include "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: microservices
    helm.sh/chart: {{ include "app.chart" . }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  replicas: {{ .Values.immich.microservices.replicas }}
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "app.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: microservices
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "app.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: microservices
    spec:
      {{- with .Values.immich.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: immich-microservices
          image: "{{ .Values.immich.microservices.image.repository }}:{{ .Values.immich.microservices.image.tag }}"
          imagePullPolicy: {{ .Values.immich.microservices.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.immich.microservices.service.port }}
          env:
            - name: TZ
              value: {{ .Values.immich.timezone | quote }}
            - name: DB_HOSTNAME
              value: {{ include "app.fullname" . }}-database
            - name: DB_PORT
              value: {{ .Values.immich.database.service.port | quote }}
            - name: DB_USERNAME
              value: {{ .Values.immich.microservices.env.DB_USERNAME | quote }}
            - name: DB_DATABASE_NAME
              value: {{ .Values.immich.microservices.env.DB_DATABASE_NAME | quote }}
            - name: DB_PASSWORD
              value: {{ .Values.immich.microservices.env.DB_PASSWORD | quote }}
            - name: REDIS_HOSTNAME
              value: {{ include "app.fullname" . }}-redis
            - name: REDIS_PORT
              value: {{ .Values.immich.redis.service.port | quote }}
            - name: IMMICH_MACHINE_LEARNING_URL
              value: http://{{ include "app.fullname" . }}-ml:{{ .Values.immich.machineLearning.service.port }}
            - name: IMMICH_WORKERS_INCLUDE
              value: 'api,microservices'
          volumeMounts:
            {{- range .Values.immich.externalvolumes }}
            - name: {{ .name }}
              mountPath: {{ .mountPath }}
              {{- if hasKey . "readOnly" }}
              readOnly: {{ .readOnly }}
              {{- end }}
            {{- end }}
      volumes:
        {{- range .Values.immich.externalvolumes }}
        - name: {{ .name }}
          nfs:
            server: {{ .server }}
            path: {{ .path }}
        {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "app.fullname" . }}-ml
  labels:
    app.kubernetes.io/name: {{ include "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: machine-learning
    helm.sh/chart: {{ include "app.chart" . }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  replicas: {{ .Values.immich.machineLearning.replicas }}
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "app.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: machine-learning
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "app.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: machine-learning
    spec:
      {{- with .Values.immich.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: immich-machine-learning
          image: "{{ .Values.immich.machineLearning.image.repository }}:{{ .Values.immich.machineLearning.image.tag }}"
          imagePullPolicy: {{ .Values.immich.machineLearning.image.pullPolicy }}
          ports:
            - name: http
              containerPort: {{ .Values.immich.machineLearning.service.port }}
          env:
            - name: TZ
              value: {{ .Values.immich.timezone | quote }}
          volumeMounts:
            - name: model-cache
              mountPath: {{ .Values.immich.machineLearning.volume.modelCache.containerMountPath }}
      volumes:
        - name: model-cache
          {{- if .Values.immich.machineLearning.volume.modelCache.enabled }}
          nfs:
            server: {{ .Values.immich.machineLearning.volume.modelCache.server }}
            path: {{ .Values.immich.machineLearning.volume.modelCache.path }}
          {{- else }}
          emptyDir: {}
          {{- end }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "app.fullname" . }}-redis
  labels:
    app.kubernetes.io/name: {{ include "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: redis
    helm.sh/chart: {{ include "app.chart" . }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "app.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: redis
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "app.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: redis
    spec:
      {{- with .Values.immich.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: redis
          image: "{{ .Values.immich.redis.image.repository }}:{{ .Values.immich.redis.image.tag }}"
          imagePullPolicy: {{ .Values.immich.redis.image.pullPolicy }}
          ports:
            - name: redis
              containerPort: {{ .Values.immich.redis.service.port }}
          livenessProbe:
            exec:
              command: ["sh", "-c", "redis-cli ping"]
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            exec:
              command: ["sh", "-c", "redis-cli ping"]
            initialDelaySeconds: 5
            periodSeconds: 15
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ include "app.fullname" . }}-database
  labels:
    app.kubernetes.io/name: {{ include "app.name" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/component: database
    helm.sh/chart: {{ include "app.chart" . }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
spec:
  serviceName: {{ include "app.fullname" . }}-database
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "app.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: database
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "app.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: database
    spec:
      {{- with .Values.immich.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: postgres
          image: "{{ .Values.immich.database.image.repository }}:{{ .Values.immich.database.image.tag }}"
          imagePullPolicy: {{ .Values.immich.database.image.pullPolicy }}
          ports:
            - name: postgres
              containerPort: {{ .Values.immich.database.service.port }}
          env:
            - name: POSTGRES_PASSWORD
              value: {{ .Values.immich.apiserver.env.DB_PASSWORD | quote }}
            - name: POSTGRES_USER
              value: {{ .Values.immich.apiserver.env.DB_USERNAME | quote }}
            - name: POSTGRES_DB
              value: {{ .Values.immich.apiserver.env.DB_DATABASE_NAME | quote }}
            - name: POSTGRES_INITDB_ARGS
              value: --data-checksums
          volumeMounts:
            - name: db-data
              mountPath: {{ .Values.immich.database.volume.database.containerMountPath }}
          resources:
            requests:
              memory: {{ .Values.immich.database.shmSize }}
          livenessProbe:
            tcpSocket:
              port: postgres
            initialDelaySeconds: 20
            periodSeconds: 30
          readinessProbe:
            tcpSocket:
              port: postgres
            initialDelaySeconds: 10
            periodSeconds: 10
      volumes:
        - name: db-data
          nfs:
            server: {{ .Values.immich.database.volume.database.server }}
            path: {{ .Values.immich.database.volume.database.path }}
